### offboard_commander.md

#### **Описание `OffboardCommander`**

`OffboardCommander` — это класс, отвечающий за управление дроном в режиме Offboard. Он позволяет отправлять команды позиционирования, скорости и траекторные точки с использованием ROS 2 и взаимодействовать с автопилотом PX4. Основной принцип работы заключается в периодической публикации сообщений в формате, поддерживаемом PX4, для управления состоянием дрона.

---

### **Принципы работы Offboard режима**

1. **Offboard режим PX4:**
   - PX4 переходит в режим Offboard, если на определённые топики (например, `offboard_control_mode` и `trajectory_setpoint`) публикуются команды с заданной частотой.
   - Отправка команд должна быть регулярной, чтобы поддерживать состояние Offboard.

2. **Основные топики:**
   - **`offboard_control_mode`:** Указывает тип управления (позиция, скорость, ускорение).
   - **`trajectory_setpoint`:** Передаёт целевые параметры траектории (позицию, скорость, ускорение, ориентацию).

3. **Обновление параметров:**
   - Параметры команды обновляются через метод `update`, где можно задать позицию, скорость, ускорение, yaw и yaw_speed.

---

### **Основные функции класса**

#### **1. Инициализация**
Класс инициализируется с привязкой к базовому контроллеру и настройкой таймера для периодической отправки команд.
```python
def __init__(self, controller: X500BaseController, timer_offboard=0.1)
```

- **Аргументы:**
  - `controller`: Ссылка на базовый контроллер дрона.
  - `timer_offboard`: Интервал в секундах для отправки команд (по умолчанию 0.1).

- **Инициализация паблишеров:**
  - `publisher_offboard_mode`: Для публикации типа управления (позиция, скорость, ускорение).
  - `publisher_trajectory`: Для публикации траекторных точек.

#### **2. Обновление параметров**
Метод `update` позволяет задавать или изменять параметры команды, такие как позиция, скорость, yaw и т.д.
```python
def update(position=None, velocity=None, acceleration=None, yaw=None, yaw_speed=None, mode=None, system='global_ENU')
```

- **Аргументы:**
  - `position`: Точка в формате `[x, y, z]`.
  - `velocity`: Скорость в формате `[vx, vy, vz]`.
  - `acceleration`: Ускорение в формате `[ax, ay, az]`.
  - `yaw`: Угол ориентации (в радианах).
  - `yaw_speed`: Скорость изменения yaw.
  - `mode`: Режим отправки команд (`position`, `velocity`, `mixed`).
  - `system`: Система координат (`local_NED`, `local_ENU`, `global_ENU`, `global_NED`).

#### **3. Отправка команды Offboard режима**
Метод `send_offboard_mode` публикует тип управления (позиция, скорость, ускорение) на топик `offboard_control_mode`.
```python
def send_offboard_mode(position=False, velocity=False, acceleration=False)
```

- **Аргументы:**
  - `position`: Включить управление по позиции.
  - `velocity`: Включить управление по скорости.
  - `acceleration`: Включить управление по ускорению.

#### **4. Отправка траекторной точки**
Метод `send_trajectory_setpoint` публикует целевые параметры траектории (позиция, скорость, yaw и т.д.) на топик `trajectory_setpoint`.
```python
def send_trajectory_setpoint()
```

- **Публикуемые данные:**
  - Позиция.
  - Скорость (если указана).
  - Ускорение (если указано).
  - Угол yaw и yaw_speed.

#### **5. Активация и деактивация**
- `activate()`: Включает периодическую отправку команд.
- `desactivate()`: Останавливает отправку команд.

#### **6. Периодическая отправка**
Метод `_timer_offboard_callback` вызывается таймером и отправляет команды в зависимости от установленного режима.
```python
def _timer_offboard_callback()
```

- Если режим `mixed`: Отправляются команды по позиции и скорости.
- Если режим `position`: Отправляются команды только по позиции.
- Если режим `velocity`: Отправляются команды только по скорости.

---

### **Пример использования**

```python
# Инициализация OffboardCommander
offboard_commander = OffboardCommander(controller)

# Установка целевых параметров
offboard_commander.update(
    position=[10.0, 5.0, -15.0],
    velocity=[0.5, 0.5, 0.0],
    yaw=1.57,
    mode='mixed'
)

# Активация режима Offboard
offboard_commander.activate()

# Через некоторое время можно изменить параметры
offboard_commander.update(
    position=[15.0, 10.0, -20.0],
    velocity=None,
    yaw=0.0,
    mode='position'
)

# Отключение Offboard режима
offboard_commander.desactivate()
```

---

### **Принципы взаимодействия с PX4**

1. **Регулярная отправка команд:**
   - Для поддержания режима Offboard команды должны отправляться с частотой, заданной в `timer_offboard`.

2. **Режимы управления:**
   - **`position`:** Указание целевой позиции.
   - **`velocity`:** Указание целевой скорости.
   - **`mixed`:** Совмещённое управление по позиции и скорости.

3. **Гибкость:**
   - Возможность переключения между системами координат (ENU, NED, локальными и глобальными).

4. **Публикация на топики:**
   - **`offboard_control_mode`:** Управляет типом управления (позиция, скорость).
   - **`trajectory_setpoint`:** Передаёт целевые параметры траектории.