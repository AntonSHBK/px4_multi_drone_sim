### x500_controller.md

#### **Описание контроллеров X500**

Контроллеры X500 (`X500BaseController` и `X500Controller`) предназначены для управления квадрокоптерами X500 через взаимодействие с автопилотом PX4. Они расширяют функциональность базового класса `BaseDroneController`, предоставляя специализированные методы и логику для работы с этим типом дронов. 

---

### **1. X500BaseController**

`X500BaseController` — это расширение базового класса `BaseDroneController`, адаптированное для дронов X500. Основные задачи:
- Управление состоянием дрона (армирование, взлет, посадка и другие операции).
- Обработка высокоуровневых команд.
- Взаимодействие с PX4 через MAVROS.

#### **Основные возможности**
1. **Поддержка команд управления:**
   - Выполнение команд движения.
   - Обновление состояния дрона.
   - Управление режимами (например, Offboard).

2. **Параметры дрона:**
   - Все параметры работы определены в классе `X500Params`, предоставляющем удобный доступ к конфигурации.

3. **Интеграция с OffboardCommander:**
   - Для режима Offboard используется `OffboardCommander`, который управляет передачей траекторий и скоростей.

---

### **2. X500Controller**

`X500Controller` расширяет `X500BaseController`, добавляя обработку пользовательских G-кодов и высокоуровневых команд. Основная цель — предоставить интерфейс для выполнения последовательностей действий, включая обработку сложных сценариев.

#### **Основные возможности**
1. **Очередь команд:**
   - Включает обработку JSON-команд, закодированных в формате G-кодов.
   - Поддерживает выполнение нескольких последовательных задач.

2. **Проверка выполнения команд:**
   - Отслеживает завершение текущей команды перед переходом к следующей.
   - Интеграция с состояниями дрона для проверки выполнения задач.

3. **Интерфейс для G-кодов:**
   - Использует расширяемый подход с базовыми командами (`BaseGCommand`) для реализации новых сценариев.

---

### **3. X500Params**

`X500Params` — это класс для хранения параметров дрона X500. Он содержит:
- **Параметры арминга:**
  - `arm_message`: состояние арминга (True/False).
  - `arm_state`: текущее состояние арминга.
- **Параметры полета:**
  - Максимальные скорости.
  - Высота взлета.
  - Ограничения по углу наклона.
- **Параметры взаимодействия с PX4:**
  - Частоты обновления команд.
  - Время таймаута для различных операций.

#### **Пример использования**
```python
params = X500Params()
params.arm_message = True
params.max_speed = 5.0
params.takeoff_height = 10.0
```

---

### **4. OffboardCommander**

`OffboardCommander` — это специализированный класс для управления дроном в режиме Offboard. Его основные задачи:
- Публикация траекторий и скоростей в режиме Offboard.
- Обновление целевых точек для движения.
- Поддержание периодической отправки команд для предотвращения отключения режима.

#### **Основные возможности**
1. **Обновление траекторий:**
   - Метод `update_targets` позволяет задать новые координаты или скорости.

2. **Публикация команд:**
   - Использует ROS 2 топики для передачи целевых значений позиций или скоростей.

3. **Контроль частоты:**
   - Поддерживает постоянное обновление команд с заданной частотой для стабильной работы PX4.

#### **Пример использования**
```python
from x500_controller import OffboardCommander

# Инициализация OffboardCommander
offboard_commander = OffboardCommander(controller)

# Задание новой траектории
offboard_commander.update_targets(x=10.0, y=5.0, z=15.0, yaw=1.57)

# Публикация траектории
offboard_commander.publish_target()
```

---

### **Архитектура и взаимодействие**

1. **X500BaseController**:
   - Реализует общую логику управления дроном.
   - Обеспечивает методы для базовых операций (взлет, посадка, удержание позиции).

2. **X500Controller**:
   - Добавляет обработку высокоуровневых G-команд.
   - Поддерживает расширение функциональности через пользовательские команды.

3. **OffboardCommander**:
   - Управляет режимом Offboard и взаимодействует с PX4.
   - Обеспечивает точное управление траекторией и скоростями.

4. **X500Params**:
   - Объединяет параметры дрона в одном классе для удобного доступа.